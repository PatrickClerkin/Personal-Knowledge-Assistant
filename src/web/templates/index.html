<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --border: #2a2d3a;
            --text: #e4e4e7;
            --muted: #71717a;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        header h1 { font-size: 1.8rem; font-weight: 600; }
        header p { color: var(--muted); margin-top: 0.25rem; }

        .stats {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .stat {
            background: var(--surface);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--muted);
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Search */
        .search-box {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        input[type="text"], textarea {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus { border-color: var(--accent); }

        button {
            padding: 0.75rem 1.5rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }

        button:hover { background: var(--accent-hover); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Results */
        .result {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .result-rank { font-weight: 600; }
        .result-score {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .score-high { background: #22c55e22; color: var(--success); }
        .score-mid { background: #f59e0b22; color: var(--warning); }
        .score-low { background: #ef444422; color: var(--error); }

        .result-source { font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem; }
        .result-content { font-size: 0.9rem; line-height: 1.5; color: #d1d5db; }

        /* Upload */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .upload-zone:hover { border-color: var(--accent); }
        .upload-zone.dragover { border-color: var(--accent); background: #6366f108; }
        .upload-zone p { color: var(--muted); }
        .upload-zone .formats { font-size: 0.8rem; margin-top: 0.5rem; }

        /* Chat */
        .chat-messages {
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .chat-msg {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            max-width: 85%;
        }

        .chat-msg.user {
            background: var(--accent);
            color: white;
            margin-left: auto;
        }

        .chat-msg.assistant {
            background: #1e2130;
            border: 1px solid var(--border);
        }

        .chat-msg h1, .chat-msg h2, .chat-msg h3 {
            margin: 0.6rem 0 0.3rem;
            font-size: 1rem;
            color: var(--accent-hover);
        }

        .chat-msg ul, .chat-msg ol {
            padding-left: 1.5rem;
            margin: 0.4rem 0;
        }

        .chat-msg li { margin: 0.25rem 0; }

        .chat-msg strong { color: #e4e4e7; }

        .chat-msg p { margin: 0.4rem 0; }

        .chat-msg code {
            background: #0f1117;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #a78bfa;
        }

        .chat-msg pre {
            background: #0f1117;
            padding: 0.75rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .chat-msg pre code {
            background: none;
            padding: 0;
        }

        .chat-msg .sources {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }

        .loading { color: var(--muted); font-style: italic; }

        .hidden { display: none; }

        #fileInput { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“š Knowledge Assistant</h1>
            <p>Document ingestion and semantic search</p>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="chunkCount">-</div>
                    <div class="stat-label">Chunks</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="docCount">-</div>
                    <div class="stat-label">Documents</div>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="search">Search</button>
            <button class="tab" data-tab="upload">Upload</button>
            <button class="tab" data-tab="chat">Chat</button>
        </div>

        <!-- Search Tab -->
        <div class="tab-content active" id="tab-search">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search your knowledge base..."
                       autofocus>
                <button id="searchBtn">Search</button>
            </div>
            <div id="searchResults"></div>
        </div>

        <!-- Upload Tab -->
        <div class="tab-content" id="tab-upload">
            <div class="upload-zone" id="uploadZone">
                <p>Drop files here or click to upload</p>
                <p class="formats">Supported: .pdf, .txt, .md, .docx</p>
            </div>
            <input type="file" id="fileInput" accept=".pdf,.txt,.md,.docx" multiple>
            <div id="uploadResults"></div>
        </div>

        <!-- Chat Tab -->
        <div class="tab-content" id="tab-chat">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-msg assistant">
                    Ask me anything about your documents. I'll find relevant
                    information and provide a grounded answer.
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="chatInput" placeholder="Ask a question...">
                <button id="chatBtn">Send</button>
            </div>
        </div>
    </div>

    <script>
        // â”€â”€â”€ Tab Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // â”€â”€â”€ Load Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadStats() {
            try {
                const res = await fetch('/api/info');
                const data = await res.json();
                document.getElementById('chunkCount').textContent = data.total_chunks;
                document.getElementById('docCount').textContent = data.num_documents;
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }
        loadStats();

        // â”€â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');

        async function doSearch() {
            const query = searchInput.value.trim();
            if (!query) return;

            searchBtn.disabled = true;
            searchResults.innerHTML = '<p class="loading">Searching...</p>';

            try {
                const res = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, top_k: 5 }),
                });
                const data = await res.json();

                if (!data.results || data.results.length === 0) {
                    searchResults.innerHTML = '<p class="loading">No results found.</p>';
                    return;
                }

                searchResults.innerHTML = data.results.map(r => {
                    const scoreClass = r.score > 0.5 ? 'score-high'
                        : r.score > 0.3 ? 'score-mid' : 'score-low';
                    const page = r.page ? ` Â· Page ${r.page}` : '';
                    return `
                        <div class="result">
                            <div class="result-header">
                                <span class="result-rank">#${r.rank}</span>
                                <span class="result-score ${scoreClass}">${r.score.toFixed(3)}</span>
                            </div>
                            <div class="result-source">${r.source}${page}</div>
                            <div class="result-content">${escapeHtml(r.content.substring(0, 400))}${r.content.length > 400 ? '...' : ''}</div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                searchResults.innerHTML = `<p class="loading">Error: ${e.message}</p>`;
            } finally {
                searchBtn.disabled = false;
            }
        }

        searchBtn.addEventListener('click', doSearch);
        searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') doSearch(); });

        // â”€â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const uploadResults = document.getElementById('uploadResults');

        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', e => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', e => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));

        async function handleFiles(files) {
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                uploadResults.innerHTML += `<p class="loading">Uploading ${file.name}...</p>`;

                try {
                    const res = await fetch('/api/ingest', {
                        method: 'POST',
                        body: formData,
                    });
                    const data = await res.json();

                    if (data.error) {
                        uploadResults.innerHTML += `<div class="result"><span style="color:var(--error)">âœ— ${file.name}: ${data.error}</span></div>`;
                    } else {
                        uploadResults.innerHTML += `<div class="result"><span style="color:var(--success)">âœ“ ${file.name}: ${data.chunks_created} chunks created</span></div>`;
                        loadStats();
                    }
                } catch (e) {
                    uploadResults.innerHTML += `<div class="result"><span style="color:var(--error)">âœ— ${file.name}: ${e.message}</span></div>`;
                }
            }
        }

        // â”€â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatBtn = document.getElementById('chatBtn');

        async function sendChat() {
            const question = chatInput.value.trim();
            if (!question) return;

            chatMessages.innerHTML += `<div class="chat-msg user">${escapeHtml(question)}</div>`;
            chatInput.value = '';
            chatBtn.disabled = true;
            chatMessages.scrollTop = chatMessages.scrollHeight;

            const loadingId = 'loading-' + Date.now();
            chatMessages.innerHTML += `<div class="chat-msg assistant loading" id="${loadingId}">Thinking...</div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question }),
                });
                const data = await res.json();

                const loadingEl = document.getElementById(loadingId);

                if (data.error) {
                    loadingEl.innerHTML = `<span style="color:var(--error)">${data.error}</span>`;
                    loadingEl.classList.remove('loading');
                } else {
                    let sourcesHtml = '';
                    if (data.sources && data.sources.length > 0) {
                        const sources = data.sources.slice(0, 3).map(s =>
                            `${s.source}${s.page ? ' p.' + s.page : ''}`
                        ).join(' Â· ');
                        sourcesHtml = `<div class="sources">Sources: ${sources}</div>`;
                    }
                    loadingEl.innerHTML = marked.parse(data.answer) + sourcesHtml;
                    loadingEl.classList.remove('loading');
                }
            } catch (e) {
                const loadingEl = document.getElementById(loadingId);
                loadingEl.innerHTML = `<span style="color:var(--error)">Error: ${e.message}</span>`;
                loadingEl.classList.remove('loading');
            } finally {
                chatBtn.disabled = false;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        chatBtn.addEventListener('click', sendChat);
        chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendChat(); });

        // â”€â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>